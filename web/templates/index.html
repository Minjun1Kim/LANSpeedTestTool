<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAN Speed Test</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>LAN Speed Test</h1>
    <form id="testForm">
        <label for="test_type">Test Type:</label>
        <select id="test_type" name="test_type">
            <option value="upload">Upload</option>
            <option value="download">Download</option>
            <option value="ping">Ping</option>
            <option value="jitter">Jitter</option>
        </select><br><br>

        <label for="server_address">Server Address:</label>
        <input type="text" id="server_address" name="server_address" required><br><br>

        <label for="size">Packet Size (bytes):</label>
        <input type="number" id="size" name="size" value="1024"><br><br>

        <label for="duration">Duration (seconds):</label>
        <input type="number" id="duration" name="duration" value="10"><br><br>

        <button type="submit">Start Test</button>
    </form>

    <h2>Results</h2>
    <pre id="results"></pre>

    <h2>Graph</h2>
    <canvas id="resultsChart"></canvas>

    <script>
        const form = document.getElementById('testForm');
        let chart; // Declare chart globally

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                test_type: document.getElementById('test_type').value,
                server_address: document.getElementById('server_address').value,
                size: document.getElementById('size').value,
                duration: document.getElementById('duration').value
            };

            // Send request to Flask server
            const response = await fetch('/start_test', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            document.getElementById('results').textContent = JSON.stringify(result, null, 2);

            if (result.status === 'success' && result.rtt_values) {
                const dataPoints = result.rtt_values.map((value, index) => ({
                    x: index + 1,  // Packet number
                    y: value       // RTT in microseconds
                }));

                // If chart already exists, update it
                if (chart) {
                    chart.data.datasets[0].data = dataPoints; // Update dataset
                    chart.update(); // Redraw chart
                } else {
                    // Create a new chart if it doesn't exist
                    chart = new Chart(document.getElementById('resultsChart'), {
                    type: 'line',
                    data: {
                        labels: result.rtt_values.map((_, index) => index + 1), // Generate labels (Packet numbers)
                        datasets: [{
                            label: 'RTT (microseconds)',
                            data: result.rtt_values, // Use RTT values directly
                            borderColor: 'blue',
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true, // Ensures the chart maintains its aspect ratio
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Packet Number'
                                },
                                ticks: {
                                    autoSkip: false // Ensures all labels are shown
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'RTT (microseconds)'
                                },
                                beginAtZero: true // Starts the Y-axis at zero
                            }
                        },
                        plugins: {
                            legend: {
                                display: true
                            }
                        }
                    }
                    });
                }

                // Display jitter
                const jitterElement = document.getElementById('jitter');
                if (!jitterElement) {
                    const newJitterElement = document.createElement('p');
                    newJitterElement.id = 'jitter';
                    newJitterElement.textContent = `Average Jitter: ${result.jitter} microseconds`;
                    document.body.appendChild(newJitterElement);
                } else {
                    jitterElement.textContent = `Average Jitter: ${result.jitter} microseconds`;
                }
            }
        });

    </script>
</body>
</html>
